= Going Headless, part 1: Guillotine and graphQL
:toc: right
:imagesdir: media/



== Some background

In the previous chapters we've looked at a "traditional CMS" way of using react4xp: as content directly presented (and augmented) by react components, served together by XP. This is fairly easy to set up and works fine for many use cases. But in other cases, we may not want such a tight connection between the content and the presentational components. There may be advantages of handling/serving them separately - or an approach where a content-exposing API works alongside a traditional CMS, as a supplement. These approaches are often called a link:https://enonic.com/blog/headless-or-decoupled-cms[headless] or link:https://enonic.com/blog/what-is-hybrid-cms[hybrid] CMS.

In Enonic XP, project link:https://developer.enonic.com/docs/headless-cms/stable[guillotine] is a go-to solution for extending the existing CMS capabilities. It exposes a read-only link:https://graphql.org/[GraphQL] API, and provides the ability to *read pure content data* (the "body" in the analogy) from XP with great flexibility and high performance.

Combining this with react as the presentational component (the "head") opens up a range of ways to use XP in headless/hybrid manners. This makes guillotine a neat and natural companion to react4xp, so the *guillotine library is included in the react4xp starter* along with two extra helper wrappers.

We will now look at how to use react4xp with guillotine in different ways, for different levels of decoupling.

== Lesson overview

This chapter will focus on setting up the guillotine API and the first usages:

- making *a graphQL query* for content data in a regular XP controller,
- using react4xp to *visualize that data*,
- letting the rendered components make *the same query from the frontend*,
- and use react to dynamically render a visualization of the returned data, and this way fill in more content as we scroll down the page: an *"infinite scroller"* page.

NOTE: The <<webapp#, next chapter>> will expand on this lesson. It demonstrates more decoupled (and less XP-centric) ways to use these same react4xp components in a _standalone webapp_, to render content data from a guillotine API.


=== Source files

.Files involved:
[source,files]
----
react4xp/
    myEntries/                  <!--1-->
        Movie.jsx
        MovieList.jsx
        MovieList.scss
    shared/
        Movie.jsx
        Movie.scss

site/
    content-types
        /movie/
            movie.xml           <!--2-->
    parts/
        movie-list/
            movie-list.es6      <!--3-->
            movie-list.xml
    site.xml                    <!--4-->

controllers/
    previewMovie.es6            <!--5-->

headless/                       <!--6-->
    helpers/
        movieListRequests.es6
    guillotineApi.es6
    guillotineRequest.es6

----
<1> We're going to build a site which is a list of movies, each displayed with a poster and a bit of info. The *entries* _Movie_ and _MovieList_ both import a _shared/Movie_ component. The _Movie_ entry uses it to preview a single movie item inside Content Studio, while the _MovieList_ entry displays the actual movie list site, by iterating over multiple _movie_ data items and using the _shared/Movie_ component for visualizing each item (both in a serverside-rendered and headless context).
<2> A content type for a single _movie_,
<3> A part with a controller that fetches child content items of the _movie_ content type, and renders them into MovieList,
<4> In _site.xml_ we will set up controller mappings for both the guillotine API and...
<5> ...the single-movie preview controller: displays a single movie without needing to set up a template and a part.
<6> _guillotineApi.es6_ is the actual API to guillotine. It can run graphQL queries both from XP controllers and through received HTTP requests. And _guillotineRequest.es6_ simplifies making such a request from the browser. Both of these are general-purpose and come with the starter (since version 1.1.0). But _helpers/movieListRequests.es6_ contains helper functions specific to the lesson site we're building here: it helps with building a query for fetching movie-list data, and parsing the returned data into the `props` format that the _Movie_ component needs. These helpers are also used on both frontend and backend.


{zwsp} +


== Single movie items

NOTE: This lesson builds on the <<imports-and-dependency-chunks#webpack_config, config setup from the previous lesson>>: _react4xp.properties_, _webpack.config.react4xp.js_ and the extra NPM packages should be set up like that. If you haven't completed that section already, better take a couple of minutes and do that before proceeding.

We'll start by adding a _movie_ content type, then set up the react rendering of single movie items, and create a few movie items for the list.

{zwsp} +

=== Movie content type

{zwsp} +

=== Controller mapping

{zwsp} +

=== React components

{zwsp} +

== Static movie list

{zwsp} +

=== Controller: backend guillotine query

{zwsp} +

=== React components

{zwsp} +

== Making the list dynamic

{zwsp} +

=== Activating the guillotine API

{zwsp} +

=== Frontend guillotine API

{zwsp} +

=== Scroll listener and dynamic DOM updates


----------------------------------------------------------

The Part definition enables two editorial configurations:

.site/parts/multi-color/multi-color.xml:
[source,xml,options="nowrap"]
----

----


.site/parts/multi-color/multi-color.es6:
[source,javascript,options="nowrap"]
----

----


{zwsp} +

=== React component

.react4xp/myEntries/MultiColor.jsx:
[source,javascript,options="nowrap"]
----
----

{zwsp} +

=== Dependencies for the entry

==== Styling

.react4xp/myEntries/MultiColor.scss:
[source,sass,options="nowrap"]
----

----

{zwsp} +

.react4xp/shared/shared-styles.scss:
[source,sass,options="nowrap"]
----

----

{zwsp} +

==== Imported react components

{zwsp} +

===== Button

.react4xp/shared/Button.jsx:
[source,javascript,options="nowrap"]
----

----

.react4xp/shared/Button.scss:
[source,sass,options="nowrap"]
----

----

{zwsp} +

===== ActiveColorOval

.react4xp/shared/ActiveColorOval.jsx:
[source,javascript,options="nowrap"]
----

----

.react4xp/shared/ActiveColorOval.scss:
[source,sass,options="nowrap"]
----

----

{zwsp} +

===== ColorButtons

.react4xp/shared/ColorButtons.jsx:
[source,javascript,options="nowrap"]
----

----

.react4xp/shared/ColorButtons.scss:
[source,sass,options="nowrap"]
----

----


{zwsp} +

[[webpack_config]]
== Configuring react4xp and webpack

In this section we'll adjust some settings to make the code above work.

TIP: Some of this is covered in more detail under <<entries#, entries>> and <<jsxpath#, jsxPaths>>.

{zwsp} +

=== Folders for entries and chunks

.react4xp.properties:
[source,properties,options="nowrap"]
----

----

[NOTE]
====

====

{zwsp} +

=== Adding webpack rules

.react4xp.properties:
[source,properties,options="nowrap"]
----

----

.webpack.config.react4xp.js:
[source,javascript,options="nowrap"]
----

----

{zwsp} +

==== NPM dependencies


[source,bash,options="nowrap"]
----

----

{zwsp} +

== Setup and rendering


.Empty multicolor Part:
image:multicolor-add.png[title="Empty MultiColor part in Content Studio", width=720px]

{zwsp} +


.Multicolor Part with colors filled in:
image:multicolor-added.png[title="MultiColor part in Content Studio, with four colors added", width=720px]

{zwsp} +


.Multicolor Part, active view:
image:multicolor-preview.png[,title="MultiColor part outside of Content Studio, active view after clicking the #5d0015 button", width=720px]

{zwsp} +


== Output

.Page source from the Multicolor Part, active view (serverside rendered not selected):
[source,html,options="nowrap"]
----

----

{zwsp} +

== Further reading

-> <<entries#, Entries>>

-> <<jsxpath#, JsxPath>>

-> <<chunks#, Dependency chunks>>

{zwsp} +

<<api#, API>> reference:

-> <<api#react4xp_render, React4xp.render>>

-> <<api#react4xp_object, React4xp data objects>>

{zwsp} +
{zwsp} +




<a href="https://iconscout.com/icons/movie" target="_blank">Movie Icon</a> by <a href="https://iconscout.com/contributors/phoenix-group">Phoenix Dungeon</a> on <a href="https://iconscout.com">Iconscout</a>
